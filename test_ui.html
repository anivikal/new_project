<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Battery Smart Voicebot - Test Interface v2</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 100%);
            min-height: 100vh;
            padding: 20px;
            color: white;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
        }
        
        @media (max-width: 900px) {
            .container {
                grid-template-columns: 1fr;
            }
        }
        
        .header {
            grid-column: 1 / -1;
            text-align: center;
            margin-bottom: 10px;
        }
        
        .header h1 {
            font-size: 2rem;
            background: linear-gradient(90deg, #00d4ff, #00ff88, #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 5px;
        }
        
        .header p {
            color: #888;
            font-size: 0.9rem;
        }
        
        /* Main Chat Panel */
        .chat-panel {
            background: #1e1e3f;
            border-radius: 20px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 700px;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: #151530;
            border-radius: 12px;
            margin-bottom: 15px;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff4444;
            transition: all 0.3s;
        }
        
        .status-dot.connected {
            background: #00ff88;
            box-shadow: 0 0 15px #00ff88;
        }
        
        .status-dot.warning {
            background: #ffaa00;
            box-shadow: 0 0 15px #ffaa00;
        }
        
        .status-text {
            color: #fff;
            font-size: 0.85rem;
        }
        
        .call-info {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .call-duration {
            color: #00d4ff;
            font-weight: bold;
            font-size: 1rem;
        }
        
        .session-id {
            color: #666;
            font-size: 0.7rem;
            font-family: monospace;
        }
        
        /* Chat Messages */
        .chat-container {
            flex: 1;
            background: #151530;
            border-radius: 15px;
            overflow-y: auto;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .message {
            max-width: 90%;
            padding: 12px 16px;
            border-radius: 15px;
            margin-bottom: 12px;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.bot {
            background: linear-gradient(135deg, #2a2a4a, #3a3a5a);
            margin-right: auto;
            border-bottom-left-radius: 5px;
        }
        
        .message.user {
            background: linear-gradient(135deg, #0066ff, #0088ff);
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }
        
        .message.system {
            background: rgba(100, 100, 255, 0.15);
            color: #aaaaff;
            margin: 10px auto;
            text-align: center;
            font-size: 0.85rem;
            border: 1px solid rgba(100, 100, 255, 0.3);
        }
        
        .message.handoff {
            background: linear-gradient(135deg, rgba(255, 68, 68, 0.2), rgba(255, 100, 100, 0.2));
            color: #ff8888;
            margin: 15px auto;
            text-align: center;
            border: 2px solid #ff6666;
            padding: 15px 20px;
        }
        
        .message-content {
            margin-bottom: 8px;
            line-height: 1.5;
        }
        
        .message-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            font-size: 0.75rem;
        }
        
        .meta-badge {
            padding: 3px 8px;
            border-radius: 10px;
            font-weight: 500;
        }
        
        .meta-badge.intent {
            background: rgba(0, 212, 255, 0.2);
            color: #00d4ff;
        }
        
        .meta-badge.confidence {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }
        
        .meta-badge.confidence.low {
            background: rgba(255, 170, 0, 0.2);
            color: #ffaa00;
        }
        
        .meta-badge.sentiment {
            padding: 3px 10px;
        }
        
        .meta-badge.sentiment.positive {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }
        
        .meta-badge.sentiment.neutral {
            background: rgba(150, 150, 150, 0.2);
            color: #aaa;
        }
        
        .meta-badge.sentiment.negative {
            background: rgba(255, 100, 100, 0.2);
            color: #ff6666;
        }
        
        .meta-badge.sentiment.frustrated {
            background: rgba(255, 68, 68, 0.3);
            color: #ff4444;
            font-weight: bold;
        }
        
        /* Input Area */
        .input-area {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .text-input-row {
            display: flex;
            gap: 10px;
        }
        
        .text-input-row input {
            flex: 1;
            padding: 14px 18px;
            border: 2px solid #333;
            border-radius: 25px;
            background: #151530;
            color: white;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s;
        }
        
        .text-input-row input:focus {
            border-color: #00d4ff;
        }
        
        .text-input-row input:disabled {
            opacity: 0.5;
        }
        
        .text-input-row button {
            padding: 14px 25px;
            background: linear-gradient(135deg, #00ff88, #00d4ff);
            border: none;
            border-radius: 25px;
            color: #1a1a2e;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .text-input-row button:hover:not(:disabled) {
            transform: scale(1.05);
        }
        
        .text-input-row button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .call-buttons {
            display: flex;
            gap: 10px;
        }
        
        .call-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .call-btn.start {
            background: linear-gradient(135deg, #00ff88, #00d4ff);
            color: #1a1a2e;
        }
        
        .call-btn.end {
            background: linear-gradient(135deg, #ff4444, #ff6666);
            color: white;
        }
        
        .call-btn:hover:not(:disabled) {
            transform: scale(1.02);
        }
        
        .call-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Side Panel */
        .side-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .panel-section {
            background: #1e1e3f;
            border-radius: 15px;
            padding: 15px;
        }
        
        .panel-section h3 {
            color: #00d4ff;
            font-size: 0.9rem;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Test Scenarios */
        .scenario-grid {
            display: grid;
            gap: 8px;
        }
        
        .scenario-btn {
            padding: 10px 12px;
            background: #2a2a4a;
            border: 1px solid #333;
            border-radius: 8px;
            color: #fff;
            font-size: 0.8rem;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
        }
        
        .scenario-btn:hover:not(:disabled) {
            background: #3a3a5a;
            border-color: #00d4ff;
            transform: translateX(5px);
        }
        
        .scenario-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .scenario-btn .emoji {
            margin-right: 8px;
        }
        
        .scenario-btn.frustrated {
            border-color: #ff6666;
        }
        
        .scenario-btn.frustrated:hover:not(:disabled) {
            border-color: #ff4444;
            background: rgba(255, 68, 68, 0.1);
        }
        
        /* Settings */
        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .setting-row label {
            color: #aaa;
            font-size: 0.85rem;
        }
        
        .setting-row input[type="text"] {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #333;
            border-radius: 8px;
            background: #151530;
            color: white;
            font-size: 0.85rem;
            margin-top: 5px;
        }
        
        .toggle {
            position: relative;
            width: 50px;
            height: 26px;
        }
        
        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #333;
            transition: 0.3s;
            border-radius: 26px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }
        
        .toggle input:checked + .toggle-slider {
            background: linear-gradient(135deg, #00ff88, #00d4ff);
        }
        
        .toggle input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }
        
        /* Debug Panel */
        .debug-panel {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .debug-log {
            font-family: 'Consolas', monospace;
            font-size: 0.7rem;
            color: #888;
            background: #0a0a1a;
            padding: 8px;
            border-radius: 5px;
            margin-bottom: 5px;
            word-break: break-all;
        }
        
        .debug-log.error {
            color: #ff6666;
            border-left: 3px solid #ff4444;
        }
        
        .debug-log.success {
            color: #00ff88;
            border-left: 3px solid #00ff88;
        }
        
        /* Voice Controls */
        .voice-section {
            text-align: center;
            padding: 15px;
        }
        
        .mic-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #0066ff, #00d4ff);
            color: white;
            font-size: 1.8rem;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 20px rgba(0, 102, 255, 0.4);
        }
        
        .mic-btn:hover:not(:disabled) {
            transform: scale(1.1);
        }
        
        .mic-btn.listening {
            background: linear-gradient(135deg, #ff4444, #ff6666);
            animation: pulse 1s infinite;
        }
        
        .mic-btn:disabled {
            background: #333;
            box-shadow: none;
            cursor: not-allowed;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.08); }
        }
        
        .voice-status {
            margin-top: 10px;
            font-size: 0.85rem;
            color: #888;
            min-height: 25px;
        }
        
        .voice-status.listening {
            color: #ff6666;
        }
        
        .voice-status.speaking {
            color: #00d4ff;
        }
        
        /* Audio player */
        .audio-player {
            margin-top: 10px;
        }
        
        .audio-player audio {
            width: 100%;
            height: 35px;
        }
        
        /* Handoff Info */
        .handoff-info {
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid #ff4444;
            border-radius: 10px;
            padding: 12px;
            margin-top: 10px;
        }
        
        .handoff-info h4 {
            color: #ff6666;
            font-size: 0.85rem;
            margin-bottom: 8px;
        }
        
        .handoff-info p {
            color: #aaa;
            font-size: 0.8rem;
            margin: 3px 0;
        }
        
        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #333;
            border-top: 2px solid #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîã Battery Smart Voicebot v2</h1>
            <p>Multilingual Driver Support | Groq LLM + gTTS | Real-time Testing</p>
        </div>
        
        <!-- Main Chat Panel -->
        <div class="chat-panel">
            <div class="status-bar">
                <div class="status-indicator">
                    <div class="status-dot" id="statusDot"></div>
                    <span class="status-text" id="statusText">Disconnected</span>
                </div>
                <div class="call-info">
                    <span class="call-duration" id="callDuration">00:00</span>
                    <span class="session-id" id="sessionInfo"></span>
                </div>
            </div>
            
            <div class="chat-container" id="chatMessages">
                <div class="message system">
                    üëã Welcome! Click "Start Call" to begin testing the voicebot.
                </div>
            </div>
            
            <div class="input-area">
                <div class="text-input-row">
                    <input type="text" id="messageInput" placeholder="Type your message in Hindi/English..." disabled>
                    <button id="sendBtn" onclick="sendTextMessage()" disabled>Send</button>
                </div>
                
                <div class="call-buttons">
                    <button class="call-btn start" id="startBtn" onclick="startCall()">üìû Start Call</button>
                    <button class="call-btn end" id="endBtn" onclick="endCall()" disabled>üì¥ End Call</button>
                </div>
            </div>
        </div>
        
        <!-- Side Panel -->
        <div class="side-panel">
            <!-- Voice Controls -->
            <div class="panel-section voice-section">
                <h3>üé§ Voice Input</h3>
                <button class="mic-btn" id="micBtn" onclick="toggleMic()" disabled>üé§</button>
                <div class="voice-status" id="voiceStatus">Click to speak</div>
                <div class="audio-player" id="audioPlayer" style="display:none;">
                    <audio id="responseAudio" controls></audio>
                </div>
            </div>
            
            <!-- Quick Test Scenarios -->
            <div class="panel-section">
                <h3>‚ö° Test Scenarios</h3>
                <div class="scenario-grid">
                    <button class="scenario-btn" onclick="sendQuick('hi')" disabled>
                        <span class="emoji">üëã</span>Simple Greeting
                    </button>
                    <button class="scenario-btn" onclick="sendQuick('kaise ho bhai')" disabled>
                        <span class="emoji">üôè</span>Hinglish Greeting
                    </button>
                    <button class="scenario-btn" onclick="sendQuick('meri swap history dikhao')" disabled>
                        <span class="emoji">üìã</span>Swap History
                    </button>
                    <button class="scenario-btn" onclick="sendQuick('nearest station kahan hai')" disabled>
                        <span class="emoji">üìç</span>Nearest Station
                    </button>
                    <button class="scenario-btn" onclick="sendQuick('subscription status batao')" disabled>
                        <span class="emoji">üí≥</span>Subscription
                    </button>
                    <button class="scenario-btn" onclick="sendQuick('invoice explain karo')" disabled>
                        <span class="emoji">üßæ</span>Invoice Help
                    </button>
                    <button class="scenario-btn frustrated" onclick="sendQuick('bhai main pareshan hu')" disabled>
                        <span class="emoji">üò§</span>Frustrated User
                    </button>
                    <button class="scenario-btn frustrated" onclick="sendQuick('ye sab galat hai! agent se baat karao')" disabled>
                        <span class="emoji">üò°</span>Request Agent
                    </button>
                </div>
            </div>
            
            <!-- Settings -->
            <div class="panel-section">
                <h3>‚öôÔ∏è Settings</h3>
                <div class="setting-row" style="flex-direction: column; align-items: stretch;">
                    <label>API URL</label>
                    <input type="text" id="apiUrl" value="http://localhost:8000">
                </div>
                <div class="setting-row">
                    <label>üîä Voice Output (Browser TTS)</label>
                    <label class="toggle">
                        <input type="checkbox" id="ttsEnabled" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="setting-row">
                    <label>üéµ Play Server Audio</label>
                    <label class="toggle">
                        <input type="checkbox" id="playServerAudio" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="setting-row">
                    <label>üé§ Auto-listen</label>
                    <label class="toggle">
                        <input type="checkbox" id="autoListen">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
            
            <!-- Debug Log -->
            <div class="panel-section">
                <h3>üîç Debug Log</h3>
                <div class="debug-panel" id="debugPanel">
                    <div class="debug-log">Ready to connect...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State
        let sessionId = null;
        let callId = null;
        let isListening = false;
        let callStartTime = null;
        let callTimer = null;
        let recognition = null;
        let synthesis = window.speechSynthesis;
        let lastHandoffInfo = null;
        
        // Elements
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const sessionInfo = document.getElementById('sessionInfo');
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const startBtn = document.getElementById('startBtn');
        const endBtn = document.getElementById('endBtn');
        const micBtn = document.getElementById('micBtn');
        const voiceStatus = document.getElementById('voiceStatus');
        const callDuration = document.getElementById('callDuration');
        const debugPanel = document.getElementById('debugPanel');
        const audioPlayer = document.getElementById('audioPlayer');
        const responseAudio = document.getElementById('responseAudio');
        
        // Scenario buttons
        const scenarioBtns = document.querySelectorAll('.scenario-btn');
        
        // Debug logging
        function debugLog(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `debug-log ${type}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            debugPanel.insertBefore(div, debugPanel.firstChild);
            
            // Keep only last 20 logs
            while (debugPanel.children.length > 20) {
                debugPanel.removeChild(debugPanel.lastChild);
            }
        }
        
        // Initialize Speech Recognition
        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
            } else if ('SpeechRecognition' in window) {
                recognition = new SpeechRecognition();
            } else {
                debugLog('Speech recognition not supported', 'error');
                return false;
            }
            
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'hi-IN';
            
            recognition.onstart = () => {
                isListening = true;
                micBtn.classList.add('listening');
                micBtn.textContent = 'üî¥';
                voiceStatus.textContent = 'üé§ Listening... speak now';
                voiceStatus.className = 'voice-status listening';
            };
            
            recognition.onresult = (event) => {
                let transcript = '';
                let isFinal = false;
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    transcript += event.results[i][0].transcript;
                    if (event.results[i].isFinal) isFinal = true;
                }
                
                voiceStatus.textContent = 'üí¨ ' + transcript;
                
                if (isFinal && transcript.trim()) {
                    sendMessage(transcript.trim());
                }
            };
            
            recognition.onerror = (event) => {
                debugLog(`Speech error: ${event.error}`, 'error');
                voiceStatus.textContent = '‚ùå ' + event.error;
                stopListening();
            };
            
            recognition.onend = () => {
                stopListening();
            };
            
            return true;
        }
        
        function toggleMic() {
            if (!sessionId) {
                debugLog('Start a call first', 'error');
                return;
            }
            
            if (isListening) {
                recognition.stop();
            } else {
                startListening();
            }
        }
        
        function startListening() {
            if (!recognition && !initSpeechRecognition()) return;
            
            synthesis.cancel();
            
            try {
                recognition.start();
                debugLog('Started listening');
            } catch (e) {
                debugLog(`Recognition error: ${e.message}`, 'error');
            }
        }
        
        function stopListening() {
            isListening = false;
            micBtn.classList.remove('listening');
            micBtn.textContent = 'üé§';
            voiceStatus.className = 'voice-status';
            
            setTimeout(() => {
                if (!isListening && voiceStatus.textContent.startsWith('üí¨')) {
                    voiceStatus.textContent = 'Click to speak';
                }
            }, 3000);
        }
        
        // Text-to-Speech (Browser)
        function speak(text) {
            if (!document.getElementById('ttsEnabled').checked) return;
            
            synthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'hi-IN';
            utterance.rate = 0.95;
            
            const voices = synthesis.getVoices();
            const hindiVoice = voices.find(v => v.lang.includes('hi')) || 
                              voices.find(v => v.lang.includes('en-IN'));
            if (hindiVoice) utterance.voice = hindiVoice;
            
            utterance.onstart = () => {
                voiceStatus.textContent = 'üîä Speaking...';
                voiceStatus.className = 'voice-status speaking';
            };
            
            utterance.onend = () => {
                voiceStatus.textContent = 'Click to speak';
                voiceStatus.className = 'voice-status';
                
                if (document.getElementById('autoListen').checked && sessionId) {
                    setTimeout(startListening, 500);
                }
            };
            
            synthesis.speak(utterance);
        }
        
        // Play server audio (gTTS)
        function playServerAudio(base64Audio) {
            if (!document.getElementById('playServerAudio').checked || !base64Audio) return;
            
            try {
                responseAudio.src = 'data:audio/mp3;base64,' + base64Audio;
                audioPlayer.style.display = 'block';
                responseAudio.play();
                debugLog('Playing server audio', 'success');
            } catch (e) {
                debugLog(`Audio play error: ${e.message}`, 'error');
            }
        }
        
        // API Functions
        function getApiUrl() {
            return document.getElementById('apiUrl').value.replace(/\/$/, '');
        }
        
        async function checkHealth() {
            try {
                debugLog('Checking server health...');
                const response = await fetch(`${getApiUrl()}/health`);
                const data = await response.json();
                
                if (data.status === 'healthy') {
                    statusDot.classList.add('connected');
                    statusDot.classList.remove('warning');
                    statusText.textContent = 'Server Ready';
                    debugLog('Server is healthy', 'success');
                    return true;
                }
            } catch (error) {
                statusDot.classList.remove('connected');
                statusDot.classList.add('warning');
                statusText.textContent = 'Server Error';
                debugLog(`Health check failed: ${error.message}`, 'error');
            }
            return false;
        }
        
        async function startCall() {
            if (!(await checkHealth())) {
                addMessage('‚ùå Cannot connect to server. Is it running at ' + getApiUrl() + '?', 'system');
                return;
            }
            
            try {
                debugLog('Starting call...');
                const response = await fetch(`${getApiUrl()}/api/v1/voice/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone_number: '9876543210',
                        language: 'hi-en'
                    })
                });
                
                const data = await response.json();
                debugLog(`Call started: ${data.call_id}`, 'success');
                
                sessionId = data.session_id;
                callId = data.call_id;
                sessionInfo.textContent = `ID: ${callId.substring(0, 8)}...`;
                
                // Enable controls
                startBtn.disabled = true;
                endBtn.disabled = false;
                micBtn.disabled = false;
                messageInput.disabled = false;
                sendBtn.disabled = false;
                scenarioBtns.forEach(btn => btn.disabled = false);
                
                // Start timer
                callStartTime = Date.now();
                callTimer = setInterval(updateCallDuration, 1000);
                
                // Clear chat
                chatMessages.innerHTML = '';
                
                // Show greeting
                addMessage(data.greeting_text, 'bot', {
                    intent: 'greeting',
                    confidence: 1.0,
                    sentiment: 'positive'
                });
                
                // Play audio or speak
                if (data.greeting_audio_base64) {
                    playServerAudio(data.greeting_audio_base64);
                } else {
                    speak(data.greeting_text);
                }
                
                // Initialize speech
                initSpeechRecognition();
                
            } catch (error) {
                debugLog(`Start call error: ${error.message}`, 'error');
                addMessage('‚ùå Failed to start call: ' + error.message, 'system');
            }
        }
        
        function endCall() {
            debugLog('Ending call');
            
            sessionId = null;
            callId = null;
            sessionInfo.textContent = '';
            lastHandoffInfo = null;
            
            if (callTimer) {
                clearInterval(callTimer);
                callTimer = null;
            }
            callDuration.textContent = '00:00';
            
            synthesis.cancel();
            if (recognition) recognition.stop();
            
            // Disable controls
            startBtn.disabled = false;
            endBtn.disabled = true;
            micBtn.disabled = true;
            messageInput.disabled = true;
            sendBtn.disabled = true;
            scenarioBtns.forEach(btn => btn.disabled = true);
            
            audioPlayer.style.display = 'none';
            addMessage('üì¥ Call ended', 'system');
        }
        
        function updateCallDuration() {
            if (!callStartTime) return;
            const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
            const mins = Math.floor(elapsed / 60).toString().padStart(2, '0');
            const secs = (elapsed % 60).toString().padStart(2, '0');
            callDuration.textContent = `${mins}:${secs}`;
        }
        
        async function sendMessage(text) {
            if (!callId || !text.trim()) return;
            
            addMessage(text, 'user');
            debugLog(`Sending: "${text.substring(0, 50)}..."`);
            
            // Show loading
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message system';
            loadingDiv.innerHTML = '<span class="loading"></span> Processing...';
            chatMessages.appendChild(loadingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            try {
                const response = await fetch(`${getApiUrl()}/api/v1/voice/message`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        call_id: callId,
                        text: text
                    })
                });
                
                // Remove loading
                loadingDiv.remove();
                
                const data = await response.json();
                debugLog(`Response: intent=${data.intent}, sentiment=${data.sentiment}, handoff=${data.handoff_triggered}`, 'success');
                
                addMessage(data.response_text, 'bot', {
                    intent: data.intent,
                    confidence: data.confidence,
                    sentiment: data.sentiment
                });
                
                // Play audio or speak
                if (data.response_audio_base64) {
                    playServerAudio(data.response_audio_base64);
                } else {
                    speak(data.response_text);
                }
                
                // Handle handoff
                if (data.handoff_triggered) {
                    lastHandoffInfo = data.handoff_info;
                    showHandoffMessage(data.handoff_info);
                }
                
            } catch (error) {
                loadingDiv.remove();
                debugLog(`Send error: ${error.message}`, 'error');
                addMessage('‚ùå Error: ' + error.message, 'system');
            }
        }
        
        function sendTextMessage() {
            const text = messageInput.value.trim();
            if (text) {
                sendMessage(text);
                messageInput.value = '';
            }
        }
        
        function sendQuick(text) {
            if (!sessionId) {
                addMessage('‚ö†Ô∏è Please start a call first', 'system');
                return;
            }
            sendMessage(text);
        }
        
        function showHandoffMessage(info) {
            const div = document.createElement('div');
            div.className = 'message handoff';
            div.innerHTML = `
                <div style="font-size: 1.2rem; margin-bottom: 10px;">üö® Handoff Triggered</div>
                <div style="font-size: 0.9rem;">Connecting you to a human agent...</div>
                ${info ? `
                <div class="handoff-info">
                    <h4>Handoff Details</h4>
                    <p><strong>Trigger:</strong> ${info.trigger || 'N/A'}</p>
                    <p><strong>Priority:</strong> ${info.priority || 'N/A'}</p>
                    <p><strong>Queue Position:</strong> ${info.queue_position || 'N/A'}</p>
                </div>
                ` : ''}
            `;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function addMessage(text, type, meta = {}) {
            const div = document.createElement('div');
            div.className = `message ${type}`;
            
            // Content
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = text;
            div.appendChild(contentDiv);
            
            // Meta badges for bot messages
            if (type === 'bot' && (meta.intent || meta.sentiment)) {
                const metaDiv = document.createElement('div');
                metaDiv.className = 'message-meta';
                
                if (meta.intent) {
                    const intentBadge = document.createElement('span');
                    intentBadge.className = 'meta-badge intent';
                    intentBadge.textContent = `üéØ ${meta.intent}`;
                    metaDiv.appendChild(intentBadge);
                }
                
                if (meta.confidence !== undefined) {
                    const confBadge = document.createElement('span');
                    confBadge.className = `meta-badge confidence ${meta.confidence < 0.6 ? 'low' : ''}`;
                    confBadge.textContent = `üìä ${(meta.confidence * 100).toFixed(0)}%`;
                    metaDiv.appendChild(confBadge);
                }
                
                if (meta.sentiment) {
                    const sentimentBadge = document.createElement('span');
                    let sentimentClass = 'neutral';
                    let sentimentEmoji = 'üòê';
                    
                    if (meta.sentiment === 'positive') {
                        sentimentClass = 'positive';
                        sentimentEmoji = 'üòä';
                    } else if (meta.sentiment === 'negative') {
                        sentimentClass = 'negative';
                        sentimentEmoji = 'üòû';
                    } else if (meta.sentiment === 'frustrated') {
                        sentimentClass = 'frustrated';
                        sentimentEmoji = 'üò§';
                    } else if (meta.sentiment === 'confused') {
                        sentimentClass = 'negative';
                        sentimentEmoji = 'üòï';
                    }
                    
                    sentimentBadge.className = `meta-badge sentiment ${sentimentClass}`;
                    sentimentBadge.textContent = `${sentimentEmoji} ${meta.sentiment}`;
                    metaDiv.appendChild(sentimentBadge);
                }
                
                div.appendChild(metaDiv);
            }
            
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Event listeners
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendTextMessage();
            }
        });
        
        // Load voices
        speechSynthesis.onvoiceschanged = () => {
            debugLog(`Loaded ${speechSynthesis.getVoices().length} voices`);
        };
        
        // Auto-check connection on load
        setTimeout(checkHealth, 500);
    </script>
</body>
</html>
